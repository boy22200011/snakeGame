<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æˆ¿é–“å¤šäººè²ªé£Ÿè›‡</title>
  <style>
    canvas { background: #111; display: block; margin: 20px auto; }
    body { text-align: center; color: white; background: #222; }
    #waitingMsg { color: orange; margin-top: 10px; }
    #roomInfo { color: lightgreen; margin-top: 10px; }
    #playerList { color: cyan; margin-top: 10px; white-space: pre-line; }
  </style>
</head>
<body>
  <h1>Go æˆ¿é–“å¤šäººè²ªé£Ÿè›‡</h1>

  <label>åå­—ï¼š</label>
  <input id="playerName" placeholder="è¼¸å…¥æš±ç¨±">

  <label>é¸æ“‡æˆ¿é–“ï¼š</label>
  <select id="roomSelect">
    <option value="roomA">Room A</option>
    <option value="roomB">Room B</option>
  </select>

  <label>æ¨¡å¼ï¼š</label>
  <select id="modeSelect">
    <option value="single">å–®äººæ¨¡å¼</option>
    <option value="multi">å¤šäººæ¨¡å¼</option>
  </select>

  <button onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
  <button onclick="readyGame()">Ready!</button>

  <div id="roomInfo"></div>
  <div id="playerList"></div>
  <div id="countdown"></div>
  <div id="waitingMsg"></div>

  <canvas id="game" width="400" height="400"></canvas>
  <p>æ–¹å‘éµæ§åˆ¶ï¼Œæ’åˆ°è‡ªå·±æˆ–åˆ¥äººæœƒé‡ç”Ÿï¼Œé”åˆ° 10 åˆ†éŠæˆ²çµæŸ</p>

  <script>
    const GRID_SIZE = 20;
    const TICK_RATE = 200;
    const WIN_SCORE = 10;

    let ws;
    let myId = Math.random().toString(36).slice(2, 8);
    let mySnake = [{x:5,y:5}];
    let myDir = {x:1,y:0};
    let score = 0;
    let food = [{x:8,y:8}];
    let players = {};
    let inGame = false;

    const roomSelect = document.getElementById("roomSelect");
    const modeSelect = document.getElementById("modeSelect");
    const playerNameInput = document.getElementById("playerName");
    const countdownDiv = document.getElementById("countdown");
    const waitingDiv = document.getElementById("waitingMsg");
    const roomInfoDiv = document.getElementById("roomInfo");
    const playerListDiv = document.getElementById("playerList");
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    let gameInterval = null;
    let keyBound = false;

    // æ›´æ–°æˆ¿é–“ç©å®¶åˆ—è¡¨ + Ready ç‹€æ…‹
    function updateRoomStatus(playersData) {
      let html = "ç›®å‰æˆ¿é–“ç©å®¶ï¼š\n";
      playersData.forEach(p => {
        html += (p.ready ? "âœ… " : "âŒ ") + p.name + "\n";
      });
      playerListDiv.innerHTML = html;
    }

    function joinRoom() {
      if (inGame) {
        alert("âš ï¸ éŠæˆ²é€²è¡Œä¸­ä¸èƒ½æ›æˆ¿é–“ï¼");
        return;
      }

      const room = roomSelect.value;
      const name = playerNameInput.value || "ç©å®¶";
      if (ws) ws.close();

      const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
      const wsUrl = `${wsProtocol}://${window.location.host}/ws?room=${room}&name=${encodeURIComponent(name)}`;
      const ws = new WebSocket(wsUrl);


      ws.onopen = () => {
        console.log(`âœ… ${name} å·²é€²å…¥æˆ¿é–“ [${room}]`);
        waitingDiv.innerText = "";
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "playerJoin") {
          roomInfoDiv.innerText = `ğŸ‰ ${data.name} åŠ å…¥æˆ¿é–“ï¼Œç›®å‰ ${data.count} äºº`;
        }

        if (data.type === "playerLeave") {
          roomInfoDiv.innerText = `ğŸ‘‹ ${data.name} é›¢é–‹æˆ¿é–“ï¼Œç›®å‰ ${data.count} äºº`;
        }

        if (data.type === "roomStatus") {
          updateRoomStatus(data.players);
        }

        if (data.type === "waiting") {
          waitingDiv.innerText = data.msg;
        }

        if (data.type === "startGame") {
          waitingDiv.innerText = "";
          let countdown = data.countdown;
          countdownDiv.innerText = `éŠæˆ² ${countdown} ç§’å¾Œé–‹å§‹`;

          let timer = setInterval(()=>{
            countdown--;
            countdownDiv.innerText = `éŠæˆ² ${countdown} ç§’å¾Œé–‹å§‹`;
            if (countdown <= 0) {
              clearInterval(timer);
              countdownDiv.innerText = "";
              startGame();
            }
          },1000);
        }

        if (data.type === "state") {
          if (data.id !== myId) {
            players[data.id] = data;
          } else {
            food = data.food;
          }
        }

        if (data.type === "gameOver") {
          alert(`ğŸ‰ ç©å®¶ ${data.id} è´äº†ï¼éŠæˆ²é‡ç½®`);
          resetSnake();
          score = 0;
          for (let pid in players) players[pid].score = 0;
          inGame = false;
          clearInterval(gameInterval);
          gameInterval = null;
        }
      };

      if (!keyBound) {
        window.addEventListener("keydown", handleKey);
        keyBound = true;
      }
    }

    function readyGame() {
      const mode = modeSelect.value;
      ws.send(JSON.stringify({
        type: "ready",
        id: myId,
        mode: mode,
        ready: true
      }));
    }

    function startGame() {
      if (!gameInterval) {
        console.log("âœ… éŠæˆ²é–‹å§‹ï¼");
        inGame = true;
        gameInterval = setInterval(updateSnake, TICK_RATE);
      }
    }

    function handleKey(e) {
      if (!inGame) return; 
      if (e.key === "ArrowUp" && myDir.y !== 1) myDir = {x:0,y:-1};
      if (e.key === "ArrowDown" && myDir.y !== -1) myDir = {x:0,y:1};
      if (e.key === "ArrowLeft" && myDir.x !== 1) myDir = {x:-1,y:0};
      if (e.key === "ArrowRight" && myDir.x !== -1) myDir = {x:1,y:0};
    }

    function updateSnake() {
      const head = {
        x: mySnake[0].x + myDir.x,
        y: mySnake[0].y + myDir.y
      };

      if (head.x < 0) head.x = canvas.width / GRID_SIZE - 1;
      if (head.y < 0) head.y = canvas.height / GRID_SIZE - 1;
      if (head.x >= canvas.width / GRID_SIZE) head.x = 0;
      if (head.y >= canvas.height / GRID_SIZE) head.y = 0;

      mySnake.unshift(head);

      let ateFood = false;
      for (let i=0; i<food.length; i++){
        if (head.x === food[i].x && head.y === food[i].y) {
          ateFood = true;
          score++;
          food[i] = {
            x: Math.floor(Math.random() * (canvas.width/GRID_SIZE)),
            y: Math.floor(Math.random() * (canvas.height/GRID_SIZE))
          }
        }
      }
      if (!ateFood) {
        mySnake.pop();
      }

      for (let i = 1; i < mySnake.length; i++) {
        if (head.x === mySnake[i].x && head.y === mySnake[i].y) {
          console.log("ğŸ’¥ æ’åˆ°è‡ªå·±ï¼Œé‡ç”Ÿï¼");
          resetSnake();
          break;
        }
      }

      for (let id in players) {
        const enemy = players[id];
        enemy.snake.forEach(s=>{
          if (head.x === s.x && head.y === s.y) {
            console.log(`ğŸ’¥ æ’åˆ°ç©å®¶ ${id} çš„è›‡ï¼Œé‡ç”Ÿï¼`);
            resetSnake();
          }
        });
      }

      if (score >= WIN_SCORE) {
        console.log(`ğŸ† ä½ é”åˆ° ${WIN_SCORE} åˆ†ï¼éŠæˆ²çµæŸ`);
        ws.send(JSON.stringify({
          type: "gameOver",
          id: myId
        }));
      }

      const myName = playerNameInput.value || "ç©å®¶";
      ws.send(JSON.stringify({
        type: "state",
        id: myId,
        name: myName,
        snake: mySnake,
        score: score,
        food: food
      }));

      drawGame();
    }

    function resetSnake() {
      mySnake = [{x: Math.floor(Math.random()*10), y: Math.floor(Math.random()*10)}];
      score = 0;
    }

    function drawGame() {
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle = "yellow";
      food.forEach(f=>{
        ctx.fillRect(f.x*GRID_SIZE,f.y*GRID_SIZE,GRID_SIZE,GRID_SIZE);
      });

      ctx.fillStyle = "lime";
      mySnake.forEach(s=>{
        ctx.fillRect(s.x*GRID_SIZE,s.y*GRID_SIZE,GRID_SIZE,GRID_SIZE);
      });

      ctx.fillStyle = "red";
      for (let id in players) {
        players[id].snake.forEach(s=>{
          ctx.fillRect(s.x*GRID_SIZE,s.y*GRID_SIZE,GRID_SIZE,GRID_SIZE);
        });
      }

      ctx.fillStyle = "white";
      ctx.font = "16px Arial";
      let yOffset = 20;

      const myName = playerNameInput.value || "ç©å®¶";
      ctx.fillText(`ä½ (${myName}) åˆ†æ•¸: ${score}`, canvas.width - 200, yOffset);
      yOffset += 20;

      for (let id in players) {
        const displayName = players[id].name || id;
        ctx.fillText(`${displayName}: ${players[id].score} åˆ†`, canvas.width - 200, yOffset);
        yOffset += 20;
      }
    }
  </script>
</body>
</html>
